dependencies:
  pre:
    # Don't need parallel true on these because parallel is implied for all
    # steps in dependency phase

    # Install dependencies on container 0 only
    - |
      if [[ $CIRCLE_NODE_INDEX = 0 ]]; then
        gem install bundler && bundle install --path=vendor/bundle --jobs=4 --retry=3 ;
        npm install ;
      else
        echo "This step skipped on this container" ;
      fi

    # Copy dependencies to containers 1-N
    - |
      if [[ $CIRCLE_NODE_INDEX != 0 ]]; then
        # copy actual dependencies
        scp -r node0:"$HOME/$CIRCLE_PROJECT_REPONAME/vendor" $HOME/$CIRCLE_PROJECT_REPONAME/vendor
        # copy dependency version manifest
        scp -r node0:"$HOME/$CIRCLE_PROJECT_REPONAME/Gemfile.lock" $HOME/$CIRCLE_PROJECT_REPONAME/

        # copy actual dependencies
        scp -r node0:"$HOME/$CIRCLE_PROJECT_REPONAME/node_modules" $HOME/$CIRCLE_PROJECT_REPONAME/node_modules

        # Sanity check dependencies registered properly
        cd $HOME/$CIRCLE_PROJECT_REPONAME && bundle check --path=vendor/bundle

        cd $HOME/$CIRCLE_PROJECT_REPONAME && npm install
      else
        echo "This step skipped on this container" ;
      fi

test:
  override:
    - exit 0
